<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8">
    <title>Employee & Capital Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container py-4">
    <h2 class="text-center">Employee Growth Over Time</h2>
    
    <div class="mb-3 text-center">
        <input type="number" id="companyIdInput" class="form-control w-25 d-inline" placeholder="Enter Company ID">
        <button class="btn btn-primary" onclick="fetchCompanyData()">Search</button>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <h3 class="text-center">Employees by Country</h3>
            <canvas id="countryChart"></canvas>
            <h3 class="text-center mt-4">Employees by Occupation</h3>
            <canvas id="occupationChart"></canvas>
        </div>
        <div class="col-md-8">
            <canvas id="employeeChart" class="mb-4"></canvas>
        </div>
    </div>

    <script>
        let employeeChart, countryChart, occupationChart;
        
        function fetchCompanyData() {
            const companyId = document.getElementById('companyIdInput').value;
            if (!companyId) return;
            
            $.getJSON(`/data?company_id=${companyId}`, function(data) {
                updateCharts(data);
            }).fail(function() {
                alert("Company data not found");
            });
        }
        
        function updateCharts(data) {
            const ctxEmployee = document.getElementById('employeeChart').getContext('2d');
            const ctxCountry = document.getElementById('countryChart').getContext('2d');
            const ctxOccupation = document.getElementById('occupationChart').getContext('2d');
            
            const totalEmployees = data.map(d => Object.values(d.Countries).reduce((a, b) => a + b, 0));
            const capitalRaises = data.map(d => d.Capital);
            
            let capitalRaisePoints = capitalRaises.map((val, index, arr) => 
                index > 0 && val !== arr[index - 1] ? 'star' : 'circle');
            let capitalRaiseSizes = capitalRaises.map((val, index, arr) => 
                index > 0 && val !== arr[index - 1] ? 8 : 4);
            let capitalRaiseAmounts = capitalRaises.map((val, index, arr) =>
                index > 0 && val !== arr[index - 1] ? `Capital Raised: ${(val - arr[index - 1]).toFixed(2)}M` : '');
            
            if (employeeChart) employeeChart.destroy();
            employeeChart = new Chart(ctxEmployee, {
                type: 'line',
                data: {
                    labels: data.map(d => d.Quarter),
                    datasets: [{
                        label: 'Total Employees',
                        data: totalEmployees,
                        borderColor: 'blue',
                        fill: false,
                        pointStyle: capitalRaisePoints,
                        pointRadius: capitalRaiseSizes,
                        pointHoverRadius: 10,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'category',
                            title: { display: true, text: 'Quarter' }
                        },
                        y: {
                            title: { display: true, text: 'Total Employees' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = ' Employees: ' + context.raw;
                                    if (capitalRaisePoints[context.dataIndex] === 'star') {
                                        label += ` (⭐ ${capitalRaiseAmounts[context.dataIndex]})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            updatePieCharts(data[index]);
                        }
                    }
                }
            });
            
            updatePieCharts(data[0]);
        }
        
        function updatePieCharts(selectedData) {
            const ctxCountry = document.getElementById('countryChart').getContext('2d');
            const ctxOccupation = document.getElementById('occupationChart').getContext('2d');
            
            if (countryChart) countryChart.destroy();
            countryChart = new Chart(ctxCountry, {
                type: 'pie',
                data: {
                    labels: Object.keys(selectedData.Countries),
                    datasets: [{
                        data: Object.values(selectedData.Countries),
                        backgroundColor: ['red', 'blue', 'green', 'yellow', 'orange']
                    }]
                }
            });
            
            if (occupationChart) occupationChart.destroy();
            occupationChart = new Chart(ctxOccupation, {
                type: 'pie',
                data: {
                    labels: Object.keys(selectedData.Occupations),
                    datasets: [{
                        data: Object.values(selectedData.Occupations),
                        backgroundColor: ['purple', 'cyan', 'pink', 'grey', 'brown', 'black', 'magenta']
                    }]
                }
            });
        }
    </script>
</body>
</html>